<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Guidelines | Payment Processing</title>
    <meta name="description" content="Developer Guides for Solidus">
    <link rel="shortcut icon" href="/solidus/favicon.ico">
  <link rel="apple-touch-icon" href="/solidus/apple-touch-icon.png">
    
    <link rel="preload" href="/solidus/assets/css/73.styles.eab8b2ae.css" as="style"><link rel="preload" href="/solidus/assets/js/app.8a40fd93.js" as="script"><link rel="preload" href="/solidus/assets/js/41.0e64d55c.js" as="script"><link rel="prefetch" href="/solidus/assets/js/37.b74e6c67.js"><link rel="prefetch" href="/solidus/assets/js/1.bc8aaa90.js"><link rel="prefetch" href="/solidus/assets/js/2.d4e88151.js"><link rel="prefetch" href="/solidus/assets/js/3.e88dfa7e.js"><link rel="prefetch" href="/solidus/assets/js/4.7b7ea6ef.js"><link rel="prefetch" href="/solidus/assets/js/5.8bb30487.js"><link rel="prefetch" href="/solidus/assets/js/6.6430c6fd.js"><link rel="prefetch" href="/solidus/assets/js/7.573fb1d2.js"><link rel="prefetch" href="/solidus/assets/js/8.9360dac4.js"><link rel="prefetch" href="/solidus/assets/js/9.bc0513d0.js"><link rel="prefetch" href="/solidus/assets/js/10.9de329d0.js"><link rel="prefetch" href="/solidus/assets/js/11.3ef794fe.js"><link rel="prefetch" href="/solidus/assets/js/12.a9f19247.js"><link rel="prefetch" href="/solidus/assets/js/13.10bdcfc3.js"><link rel="prefetch" href="/solidus/assets/js/14.baeb49cf.js"><link rel="prefetch" href="/solidus/assets/js/15.4d27d13f.js"><link rel="prefetch" href="/solidus/assets/js/16.4dbd3af2.js"><link rel="prefetch" href="/solidus/assets/js/17.96a840b0.js"><link rel="prefetch" href="/solidus/assets/js/18.7af603a9.js"><link rel="prefetch" href="/solidus/assets/js/19.944f2391.js"><link rel="prefetch" href="/solidus/assets/js/20.0d3a03ca.js"><link rel="prefetch" href="/solidus/assets/js/21.6f8a3623.js"><link rel="prefetch" href="/solidus/assets/js/22.1ab16961.js"><link rel="prefetch" href="/solidus/assets/js/23.c5a09552.js"><link rel="prefetch" href="/solidus/assets/js/24.01d33ebc.js"><link rel="prefetch" href="/solidus/assets/js/25.368e20d3.js"><link rel="prefetch" href="/solidus/assets/js/26.0ff243dc.js"><link rel="prefetch" href="/solidus/assets/js/27.379ef86c.js"><link rel="prefetch" href="/solidus/assets/js/28.b1d94d4e.js"><link rel="prefetch" href="/solidus/assets/js/29.a582c0f5.js"><link rel="prefetch" href="/solidus/assets/js/30.75b3694e.js"><link rel="prefetch" href="/solidus/assets/js/31.32737bfe.js"><link rel="prefetch" href="/solidus/assets/js/32.68e6e17c.js"><link rel="prefetch" href="/solidus/assets/js/33.1e8efaaa.js"><link rel="prefetch" href="/solidus/assets/js/34.349d8482.js"><link rel="prefetch" href="/solidus/assets/js/35.78fdbd6e.js"><link rel="prefetch" href="/solidus/assets/js/36.0b2759fa.js"><link rel="prefetch" href="/solidus/assets/js/0.594398bd.js"><link rel="prefetch" href="/solidus/assets/js/38.bccdd185.js"><link rel="prefetch" href="/solidus/assets/js/39.ad7f257e.js"><link rel="prefetch" href="/solidus/assets/js/40.18604395.js"><link rel="prefetch" href="/solidus/assets/js/42.83301a40.js"><link rel="prefetch" href="/solidus/assets/js/43.f596cdc7.js"><link rel="prefetch" href="/solidus/assets/js/44.07f48a7c.js"><link rel="prefetch" href="/solidus/assets/js/45.a59da533.js"><link rel="prefetch" href="/solidus/assets/js/46.adca66b1.js"><link rel="prefetch" href="/solidus/assets/js/47.61b9b3b8.js"><link rel="prefetch" href="/solidus/assets/js/48.94da6411.js"><link rel="prefetch" href="/solidus/assets/js/49.045da191.js"><link rel="prefetch" href="/solidus/assets/js/50.4aa1c95a.js"><link rel="prefetch" href="/solidus/assets/js/51.3f25a7cb.js"><link rel="prefetch" href="/solidus/assets/js/52.7fc3e97e.js"><link rel="prefetch" href="/solidus/assets/js/53.478f3a20.js"><link rel="prefetch" href="/solidus/assets/js/54.bee46771.js"><link rel="prefetch" href="/solidus/assets/js/55.d22fc5aa.js"><link rel="prefetch" href="/solidus/assets/js/56.2779de7d.js"><link rel="prefetch" href="/solidus/assets/js/57.9229e917.js"><link rel="prefetch" href="/solidus/assets/js/58.53b44760.js"><link rel="prefetch" href="/solidus/assets/js/59.b4ab94d2.js"><link rel="prefetch" href="/solidus/assets/js/60.024d7dba.js"><link rel="prefetch" href="/solidus/assets/js/61.c0c81db2.js"><link rel="prefetch" href="/solidus/assets/js/62.9766010b.js"><link rel="prefetch" href="/solidus/assets/js/63.a22ac1c9.js"><link rel="prefetch" href="/solidus/assets/js/64.711f7334.js"><link rel="prefetch" href="/solidus/assets/js/65.0f534f00.js"><link rel="prefetch" href="/solidus/assets/js/66.e38c54e1.js"><link rel="prefetch" href="/solidus/assets/js/67.a395f431.js"><link rel="prefetch" href="/solidus/assets/js/68.f86e2d51.js"><link rel="prefetch" href="/solidus/assets/js/69.6f1fc43a.js"><link rel="prefetch" href="/solidus/assets/js/70.944af6a0.js"><link rel="prefetch" href="/solidus/assets/js/71.1f9a1de8.js"><link rel="prefetch" href="/solidus/assets/js/72.3e4d2c2a.js">
    <link rel="stylesheet" href="/solidus/assets/css/73.styles.eab8b2ae.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/solidus/" class="home-link router-link-active"><img src="/solidus/logo.svg" class="logo"><span class="site-name can-hide">
      Guidelines
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/solidus/" class="nav-link">Home</a></div><a href="https://github.com/solidusio/solidus" target="_blank" rel="noopener noreferrer" class="github-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/solidus/" class="nav-link">Home</a></div><a href="https://github.com/solidusio/solidus" target="_blank" rel="noopener noreferrer" class="github-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Getting Started</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Preferences</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Locations</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Payments</span><span class="arrow up"></span></p><ul class="sidebar-group-items"><li><a href="/solidus/payments/overview.html" class="sidebar-link">Overview</a></li><li><a href="/solidus/payments/payments.html" class="sidebar-link">Payments</a></li><li><a href="/solidus/payments/payment-methods.html" class="sidebar-link">Payment methods</a></li><li><a href="/solidus/payments/payment-sources.html" class="sidebar-link">Payment sources</a></li><li><a href="/solidus/payments/payment_processing.html" class="active sidebar-link">Payment Processing</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/solidus/payments/payment_processing.html#gateway-options" class="sidebar-link">Gateway Options</a></li><li class="sidebar-sub-header"><a href="/solidus/payments/payment_processing.html#credit-card-data" class="sidebar-link">Credit Card Data</a></li><li class="sidebar-sub-header"><a href="/solidus/payments/payment_processing.html#processing-walkthrough" class="sidebar-link">Processing Walkthrough</a></li><li class="sidebar-sub-header"><a href="/solidus/payments/payment_processing.html#log-entries" class="sidebar-link">Log Entries</a></li></ul></li><li><a href="/solidus/payments/payment-service-providers.html" class="sidebar-link">Payment service providers</a></li><li><a href="/solidus/payments/custom_gateway.html" class="sidebar-link">Building a custom gateway</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Taxation</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Shipments</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Calculators</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Assets</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Views</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Products and Variants</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Inventory</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Returns</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Promotions</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Adjustments</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Orders</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Returns</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Users</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Upgrades</span><span class="arrow down"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Extensions</span><span class="arrow down"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="payment-processing"><a href="#payment-processing" aria-hidden="true" class="header-anchor">#</a> Payment Processing</h1><p>Payment processing in Spree supports many different gateways, but also attempts
to comply with the API provided by the <a href="https://github.com/activemerchant/active_merchant" target="_blank" rel="noopener noreferrer">active_merchant</a> gem where possible.</p><h2 id="gateway-options"><a href="#gateway-options" aria-hidden="true" class="header-anchor">#</a> Gateway Options</h2><p>For every gateway action, a list of gateway options are passed through.</p><ul><li><code>email</code> and <code>customer</code>: The email address related to the order</li><li><code>ip</code>: The last IP address for the order</li><li><code>order_id</code>: The Order's <code>number</code> attribute, plus the <code>identifier</code> for each payment, generated when the payment is first created</li><li><code>originator</code>: the payment itself</li><li><code>shipping</code>: The total shipping cost for the order, in cents</li><li><code>tax</code>: The total tax cost for the order, in cents</li><li><code>subtotal</code>: The item total for the order, in cents</li><li><code>discount</code>: The promotional discount applied to the order, in cents</li><li><code>currency</code>: The 3-character currency code for the order</li><li><code>billing_address</code>: A hash containing billing address information</li><li><code>shipping_address</code>: A hash containing shipping address information</li></ul><p>The billing address and shipping address data is as follows:</p><ul><li><code>name</code>: The combined <code>first_name</code> and <code>last_name</code> from the address</li><li><code>address1</code>: The first line of the address information</li><li><code>address2</code>: The second line of address information</li><li><code>city</code>: The city of the address</li><li><code>state</code>: An abbreviated version of the state name or, failing that, the state name itself, from the related <code>State</code> object. If that fails, the <code>state_name</code> attribute from the address.</li><li><code>country</code>: The ISO name for the country. For example, United States of America is &quot;US&quot;, Australia is &quot;AU&quot;.</li><li><code>phone</code>: The phone number associated with the address</li></ul><h2 id="credit-card-data"><a href="#credit-card-data" aria-hidden="true" class="header-anchor">#</a> Credit Card Data</h2><p>Solidus stores only the type, expiration date, name and last four digits for the
card on your server. This data can then be used to present to the user so that
they can verify that the correct card is being used. All credit card data sent
through forms is sent through immediately to the gateways, and is not stored for
any period of time.</p><h2 id="processing-walkthrough"><a href="#processing-walkthrough" aria-hidden="true" class="header-anchor">#</a> Processing Walkthrough</h2><p>When an order is completed in Solidus, each <code>Payment</code> object associated with the
order has the <code>process!</code> method called on it, unless <code>payment_required?</code> for the
order returns <code>false</code>, in order to attempt to automatically fulfill the payment
required for the order.</p><p>If the payment method requires a source, and the payment has a source associated
with it, then Solidus will attempt to process the payment. Otherwise, the
payment will need to be processed manually.</p><p>If the <code>PaymentMethod</code> object is configured to auto-capture payments, then the
<code>Payment#purchase!</code> method will be called, which will call
<code>PaymentMethod#purchase</code> like this:</p><pre class="language-ruby"><code>payment_method<span class="token punctuation">.</span><span class="token function">purchase</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>amount<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>source<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>gateway options<span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre><p>If the payment is <em>not</em> configured to auto-capture payments, the
<code>Payment#authorize!</code> method will be called, with the same arguments as the
<code>purchase</code> method above:</p><pre class="language-ruby"><code>payment_method<span class="token punctuation">.</span><span class="token function">authorize</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>amount<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>source<span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>gateway options<span class="token operator">&gt;</span><span class="token punctuation">)</span>
</code></pre><p>How the payment is actually put through depends on the <code>PaymentMethod</code>
sub-class' implementation of the <code>purchase</code> and <code>authorize</code> methods.</p><p>The returned object from both the <code>purchase</code> and <code>authorize</code> methods on the
payment method objects must be an <code>ActiveMerchant::Billing::Response</code> object.
This response object is then stored (in YAML) in the <code>spree_log_entries</code> table.
Log entries can be retrieved with a call to the <code>log_entries</code> association on any
<code>Payment</code> object.</p><p>If the <code>purchase!</code> route is taken and is successful, the payment is marked as
<code>completed</code>. If it fails, it is marked as <code>failed</code>. If the <code>authorize</code> method is
successful, the payment is transitioned to the <code>pending</code> state so that it can be
manually captured later by calling the <code>capture!</code> method. If it is unsuccessful,
it is also transitioned to the <code>failed</code> state.</p><hr><p>Once a payment has been saved, it also updates the order. This may trigger the
<code>payment_state</code> to change, which would reflect the current payment state of the
order. The possible states are:</p><ul><li><code>balance_due</code>: Indicates that payment is required for this order</li><li><code>failed</code>: Indicates that the last payment for the order failed</li><li><code>credit_owed</code>: This order has been paid for in excess of its total</li><li><code>paid</code>: This order has been paid for in full.</li></ul><hr><p>!!!
You may want to keep tabs on the number of orders with a <code>payment_state</code> of
<code>failed</code>. A sudden increase in the number of such orders could indicate a
problem with your credit card gateway and most likely indicates a serious
problem affecting customer satisfaction. You should check the latest
<code>log_entries</code> for the most recent payments in the store if this is happening.
!!!</p><h2 id="log-entries"><a href="#log-entries" aria-hidden="true" class="header-anchor">#</a> Log Entries</h2><p>Responses from payment gateways within Solidus are typically
<code>ActiveMerchant::Billing::Response</code> objects. When Solidus handles a response
from a payment gateway, it will serialize the object as YAML and store it in the
database as a log entry for a payment. These responses can be useful for
debugging why a payment has failed.</p><p>You can get a list of these log entries by calling the <code>log_entries</code> on any
<code>Spree::Payment</code> object. To get the <code>Active::Merchant::Billing::Response</code> out of
these <code>Spree::LogEntry</code> objects, call the <code>details</code> method.</p><p>You can add <a href="https://github.com/solidusio-contrib/solidus_log_viewer" target="_blank" rel="noopener noreferrer">solidus_log_viewer</a>
to get the logs next to the payments in the admin.</p></div><div class="content edit-link"><a href="https://github.com/solidusio/solidus/edit/master/guides/payments/payment_processing.md" target="_blank" rel="noopener noreferrer">Edit this page</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/solidus/payments/payment-sources.html" class="prev">
          Payment sources
        </a></span><span class="next"><a href="/solidus/payments/payment-service-providers.html">
          Payment service providers
        </a> →
      </span></p></div></div></div></div>
    <script src="/solidus/assets/js/41.0e64d55c.js" defer></script><script src="/solidus/assets/js/app.8a40fd93.js" defer></script>
  </body>
</html>
